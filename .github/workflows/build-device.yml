name: Build postmarketOS Device

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      device:
        description: 'Device codename'
        required: true
        default: 'samsung-goyave3g'
        type: string
      ui:
        description: 'User interface'
        required: true
        default: 'i3wm'
        type: choice
        options:
          - none
          - console
          - gnome
          - plasma-mobile
          - plasma-desktop
          - phosh
          - sxmo-de-sway
          - xfce4
          - i3wm
          - wlroots
      user:
        description: 'Username'
        required: true
        default: 'pmos'
        type: string
      extra_packages:
        description: 'Extra packages (comma separated)'
        required: false
        default: 'nano,vim,wget,htop'
        type: string
      kernel:
        description: 'Kernel variant'
        required: true
        default: 'stable'
        type: choice
        options:
          - stable
          - mainline
          - lts
      ssh_keys:
        description: 'Enable SSH keys'
        required: true
        default: false
        type: boolean
      custom_ssh_key:
        description: 'Custom SSH public key'
        required: false
        default: ''
        type: string
      wifi_backend:
        description: 'WiFi backend'
        required: true
        default: 'wpa_supplicant'
        type: choice
        options:
          - wpa_supplicant
          - iwd
      install_method:
        description: 'Installation method'
        required: true
        default: 'android-recovery-zip'
        type: choice
        options:
          - android-recovery-zip
          - netboot
          - rootfs

env:
  DEVICE: ${{ github.event.inputs.device || 'samsung-goyave3g' }}
  UI: ${{ github.event.inputs.ui || 'i3wm' }}
  USER: ${{ github.event.inputs.user || 'pmos' }}
  EXTRA_PACKAGES: ${{ github.event.inputs.extra_packages || 'nano,vim,wget,htop' }}
  KERNEL: ${{ github.event.inputs.kernel || 'stable' }}
  WIFI_BACKEND: ${{ github.event.inputs.wifi_backend || 'wpa_supplicant' }}
  # Custom pmaports configuration
  CUSTOM_PMAPORTS_REPO: 'https://codeberg.org/JoseskVolpe/pmaports.git'
  CUSTOM_PMAPORTS_BRANCH: 'v23.12'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    
    steps:
      - name: Maximize build space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            python3 \
            python3-pip \
            openssl \
            qemu-user-static \
            binfmt-support
          sudo update-binfmts --enable || true

      - name: Install pmbootstrap
        run: |
          git clone --depth=1 https://gitlab.postmarketos.org/postmarketOS/pmbootstrap
          cd pmbootstrap
          pip3 install --user .
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify pmbootstrap
        run: |
          pmbootstrap --version

      - name: Setup SSH keys
        if: github.event.inputs.ssh_keys == 'true'
        run: |
          mkdir -p ~/.ssh
          
          if [ -n "${{ github.event.inputs.custom_ssh_key }}" ]; then
            echo "${{ github.event.inputs.custom_ssh_key }}" > ~/.ssh/id_rsa.pub
          else
            curl -sL "https://github.com/${{ github.actor }}.keys" > ~/.ssh/id_rsa.pub || true
            if [ ! -s ~/.ssh/id_rsa.pub ]; then
              echo "# No SSH keys" > ~/.ssh/id_rsa.pub
            fi
          fi
          
          cat ~/.ssh/id_rsa.pub

      - name: Setup pmaports (using custom repository directly)
        run: |
          WORK_DIR="$HOME/.local/var/pmbootstrap"
          mkdir -p "${WORK_DIR}/cache_git"
          PMAPORTS="${WORK_DIR}/cache_git/pmaports"
          
          echo "=== Cloning custom pmaports repository ==="
          echo "Repository: ${{ env.CUSTOM_PMAPORTS_REPO }}"
          echo "Branch: ${{ env.CUSTOM_PMAPORTS_BRANCH }}"
          
          git clone --depth=1 --branch "${{ env.CUSTOM_PMAPORTS_BRANCH }}" \
            "${{ env.CUSTOM_PMAPORTS_REPO }}" \
            "${PMAPORTS}"
          
          cd "${PMAPORTS}"
          
          echo "=== Setting up git remotes for pmbootstrap compatibility ==="
          git remote rename origin custom
          git remote add origin https://gitlab.postmarketos.org/postmarketOS/pmaports.git
          git fetch origin master:refs/remotes/origin/master --depth=1
          git checkout ${{ env.CUSTOM_PMAPORTS_BRANCH }}
          
          echo "=== Configuring to use edge binary packages ==="
          # Modify channels.cfg to point v23.12 to use edge binaries
          if [ -f "channels.cfg" ]; then
            # Update v23.12 channel to use edge mirror for binaries
            sed -i 's|mirrordir_alpine = .*|mirrordir_alpine = edge|' channels.cfg
            sed -i 's|branch_aports = .*|branch_aports = edge|' channels.cfg
            echo "Modified channels.cfg:"
            cat channels.cfg | grep -A5 "\[v23.12\]" || true
          fi
          
          echo "=== Git remotes configured ==="
          git remote -v
          git branch -a
          
          echo "=== Verifying device packages exist ==="
          if [ -d "${PMAPORTS}/device/testing/device-${{ env.DEVICE }}" ]; then
            echo "âœ… Device package found: device-${{ env.DEVICE }}"
            ls -la "${PMAPORTS}/device/testing/device-${{ env.DEVICE }}/"
          else
            echo "âŒ Device package not found!"
            exit 1
          fi
          
          if [ -d "${PMAPORTS}/device/testing/linux-${{ env.DEVICE }}" ]; then
            echo "âœ… Kernel package found: linux-${{ env.DEVICE }}"
            ls -la "${PMAPORTS}/device/testing/linux-${{ env.DEVICE }}/"
          else
            echo "âŒ Kernel package not found!"
            exit 1
          fi
          
          echo "=== Checking for additional packages ==="
          ls -la "${PMAPORTS}/device/testing/" | grep "${{ env.DEVICE }}" || true

      - name: Create pmbootstrap config
        run: |
          mkdir -p ~/.config
          WORK_DIR="$HOME/.local/var/pmbootstrap"
          
          # pmbootstrap v3 config
          WIFI_PROVIDER="postmarketos-base-ui-wifi-wpa_supplicant"
          if [ "${{ env.WIFI_BACKEND }}" = "iwd" ]; then
            WIFI_PROVIDER="postmarketos-base-ui-wifi-iwd"
          fi
          
          cat > ~/.config/pmbootstrap_v3.cfg << EOF
          [pmbootstrap]
          aports = ${WORK_DIR}/cache_git/pmaports
          channel = v23.12
          device = ${{ env.DEVICE }}
          extra_packages = ${{ env.EXTRA_PACKAGES }}
          is_default_channel = False
          ssh_keys = ${{ github.event.inputs.ssh_keys || 'false' }}
          ui = ${{ env.UI }}
          user = ${{ env.USER }}
          work = ${WORK_DIR}
          
          [providers]
          postmarketos-base-ui-wifi = ${WIFI_PROVIDER}
          
          [mirrors]
          EOF
          
          echo "=== Config created ==="
          cat ~/.config/pmbootstrap_v3.cfg

      - name: Initialize pmbootstrap
        run: |
          echo "=== Initializing pmbootstrap ==="
          # Use v23.12 channel with edge binaries (configured in channels.cfg)
          printf "v23.12\n\n\n\n\n\n\n\n\ny\n\n" | pmbootstrap init || true
          
          echo "=== Checking status ==="
          pmbootstrap status

      - name: Update package indexes
        run: |
          echo "=== Updating package indexes ==="
          pmbootstrap update --non-existing || {
            echo "âš ï¸ WARNING: Some package indexes failed to download"
            echo "This is expected for v23.12 branch - will build from source"
          }

      - name: Build device packages
        continue-on-error: true
        run: |
          echo "=== Building device package ==="
          pmbootstrap build device-${{ env.DEVICE }} || echo "Device build skipped"
          
          echo "=== Building kernel ==="
          pmbootstrap build linux-${{ env.DEVICE }} || echo "Kernel build skipped"

      - name: Install postmarketOS
        run: |
          echo "=== Installing postmarketOS to image ==="
          
          INSTALL_METHOD="${{ github.event.inputs.install_method || 'android-recovery-zip' }}"
          
          # Use default password: 147147
          case "$INSTALL_METHOD" in
            android-recovery-zip)
              printf "147147\n147147\n" | pmbootstrap install \
                --android-recovery-zip \
                --recovery-install-partition=data
              ;;
            netboot)
              printf "147147\n147147\n" | pmbootstrap install --no-fde --no-image
              ;;
            rootfs)
              printf "147147\n147147\n" | pmbootstrap install --no-fde
              ;;
            *)
              printf "147147\n147147\n" | pmbootstrap install \
                --android-recovery-zip \
                --recovery-install-partition=data
              ;;
          esac

      - name: Export build artifacts
        run: |
          echo "=== Exporting artifacts ==="
          pmbootstrap export || true
          
          # List what was created
          find ~/.local/var/pmbootstrap -name "*.zip" -o -name "*.img" -o -name "*.tar.md5" 2>/dev/null || true

      - name: Collect artifacts
        run: |
          WORK_DIR="$HOME/.local/var/pmbootstrap"
          ARTIFACT_DIR="${{ github.workspace }}/artifacts"
          mkdir -p "$ARTIFACT_DIR"
          
          echo "=== Collecting build artifacts ==="
          
          # From export directories
          for export_dir in \
            "/tmp/postmarketOS-export" \
            "$WORK_DIR/export" \
            "$WORK_DIR/chroot_native/tmp/postmarketOS-export"
          do
            if [ -d "$export_dir" ]; then
              echo "Copying from: $export_dir"
              cp -rv "$export_dir"/* "$ARTIFACT_DIR/" 2>/dev/null || true
            fi
          done
          
          # Search for specific file types
          echo "Searching for build artifacts..."
          
          find "$WORK_DIR" -type f \( \
            -name "*.zip" -o \
            -name "*.tar.md5" -o \
            -name "*.img" -o \
            -name "*.img.xz" -o \
            -name "pmos-*" \
          \) -exec cp -v {} "$ARTIFACT_DIR/" \; 2>/dev/null || true
          
          # Copy SSH key
          if [ -f ~/.ssh/id_rsa.pub ]; then
            cp ~/.ssh/id_rsa.pub "$ARTIFACT_DIR/SSH_PUBLIC_KEY.txt"
          fi
          
          # Create build info
          cat > "$ARTIFACT_DIR/BUILD_INFO.txt" << EOFINFO
          PostmarketOS Build Information
          ==============================
          
          Device: ${{ env.DEVICE }}
          UI: ${{ env.UI }}
          User: ${{ env.USER }}
          Kernel: ${{ env.KERNEL }}
          WiFi: ${{ env.WIFI_BACKEND }}
          Extra Packages: ${{ env.EXTRA_PACKAGES }}
          
          Build Date: $(date -u)
          Workflow Run: #${{ github.run_number }}
          
          Installation:
          1. Boot into TWRP recovery
          2. Wipe System, Data, Cache
          3. Flash the .zip file
          4. Reboot
          
          Default password: 147147
          EOFINFO
          
          echo "=== Artifacts collected ==="
          ls -lah "$ARTIFACT_DIR"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pmos-${{ env.DEVICE }}-${{ env.UI }}-${{ github.run_number }}
          path: ${{ github.workspace }}/artifacts/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            ~/.local/var/pmbootstrap/log*.txt
            ~/.local/var/pmbootstrap/log/
            ~/.config/pmbootstrap*.cfg
          retention-days: 7
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOFSUMMARY'
          # ðŸ“± PostmarketOS Build
          
          ## Configuration
          - **Device**: `${{ env.DEVICE }}`
          - **UI**: `${{ env.UI }}`
          - **User**: `${{ env.USER }}`
          - **Kernel**: `${{ env.KERNEL }}`
          - **WiFi**: `${{ env.WIFI_BACKEND }}`
          - **Packages**: `${{ env.EXTRA_PACKAGES }}`
          
          ## Status
          - Build #${{ github.run_number }}
          - Triggered by: @${{ github.actor }}
          
          ## Installation
          1. Download `.zip` from Artifacts
          2. Boot to TWRP recovery
          3. Wipe â†’ Factory Reset
          4. Install â†’ Select `.zip`
          5. Reboot
          
          **Default password**: `147147`
          
          ## Resources
          - [Device Wiki](https://wiki.postmarketos.org/wiki/Device:${{ env.DEVICE }})
          - [Installation Guide](https://wiki.postmarketos.org/wiki/Installation_guide)
          
          ---
          Built: $(date -u)
          EOFSUMMARY
